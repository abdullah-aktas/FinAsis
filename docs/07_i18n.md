# 7. Dil ve YerelleÅŸtirme (i18n)

## ğŸ“Œ AmaÃ§
Bu dokÃ¼mantasyon, FinAsis projesinin Ã§oklu dil desteÄŸi ve yerelleÅŸtirme Ã¶zelliklerini detaylandÄ±rmaktadÄ±r.

## âš™ï¸ Teknik YapÄ±

### 1. Dil DosyalarÄ±

#### 1.1. JSON TabanlÄ± Dil DosyalarÄ±
```json
// locale/tr/LC_MESSAGES/django.json
{
    "common": {
        "save": "Kaydet",
        "cancel": "Ä°ptal",
        "delete": "Sil",
        "edit": "DÃ¼zenle",
        "search": "Ara",
        "filter": "Filtrele"
    },
    "auth": {
        "login": "GiriÅŸ Yap",
        "logout": "Ã‡Ä±kÄ±ÅŸ Yap",
        "register": "KayÄ±t Ol",
        "password": "Åifre",
        "email": "E-posta"
    },
    "finance": {
        "invoice": "Fatura",
        "payment": "Ã–deme",
        "customer": "MÃ¼ÅŸteri",
        "amount": "Tutar",
        "date": "Tarih",
        "status": "Durum"
    }
}
```

#### 1.2. Django Mesaj DosyalarÄ± (.po ve .mo)

Django'nun yerelleÅŸtirme sistemi .po (Portable Object) dosyalarÄ±nÄ± Ã§eviri tanÄ±mlarÄ± iÃ§in ve .mo (Machine Object) dosyalarÄ±nÄ± derlenmiÅŸ Ã§eviriler iÃ§in kullanÄ±r.

```bash
# Mesaj dosyalarÄ±nÄ± oluÅŸturma
python manage.py makemessages -l tr
python manage.py makemessages -l en
python manage.py makemessages -l de
python manage.py makemessages -l ar
python manage.py makemessages -l ku
python manage.py makemessages -l fr

# Mesaj dosyalarÄ±nÄ± derleme
python manage.py compilemessages
```

#### 1.3. Dil YÃ¼kleyici
```python
# i18n/loader.py
import json
import os
from django.conf import settings
from django.utils.translation import gettext as _

class LanguageLoader:
    def __init__(self):
        self.translations = {}
        self.default_language = settings.LANGUAGE_CODE
    
    def load_language(self, language_code):
        if language_code not in self.translations:
            file_path = os.path.join(
                settings.BASE_DIR,
                'locale',
                language_code,
                'LC_MESSAGES',
                'django.json'
            )
            
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    self.translations[language_code] = json.load(f)
            except FileNotFoundError:
                self.translations[language_code] = {}
        
        return self.translations[language_code]
    
    def get_translation(self, key, language_code=None):
        language_code = language_code or self.default_language
        translations = self.load_language(language_code)
        
        keys = key.split('.')
        value = translations
        
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                # Django'nun standart Ã§eviri sistemini de kullan
                django_key = ".".join(keys)
                return _(django_key)
        
        return value
```

### 2. Ã‡eviri Sistemi

#### 2.1. Django Entegrasyonu
```python
# settings.py
MIDDLEWARE = [
    'django.middleware.locale.LocaleMiddleware',
    # ...
]

LANGUAGES = [
    ('tr', 'TÃ¼rkÃ§e'),
    ('en', 'English'),
    ('ku', 'KurdÃ®'),
    ('ar', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'),
    ('de', 'Deutsch'),
    ('fr', 'FranÃ§ais')
]

LOCALE_PATHS = [
    os.path.join(BASE_DIR, 'locale'),
]

# i18n/middleware.py
from django.utils import translation
from django.conf import settings

class LanguageMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # KullanÄ±cÄ± tercihini kontrol et
        user_language = request.session.get('django_language')
        if user_language:
            translation.activate(user_language)
        
        response = self.get_response(request)
        translation.deactivate()
        return response
```

#### 2.2. Template KullanÄ±mÄ±
```html
<!-- templates/base.html -->
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <title>{% trans "FinAsis" %}</title>
</head>
<body>
    <nav>
        <select onchange="changeLanguage(this.value)">
            {% get_available_languages as LANGUAGES %}
            {% get_language_info_list for LANGUAGES as languages %}
            {% for language in languages %}
                <option value="{{ language.code }}"
                        {% if language.code == LANGUAGE_CODE %}selected{% endif %}>
                    {{ language.name_local }}
                </option>
            {% endfor %}
        </select>
    </nav>
    
    <main>
        {% block content %}{% endblock %}
    </main>
</body>
</html>
```

### 3. RTL DesteÄŸi

#### 3.1. CSS YapÄ±landÄ±rmasÄ±
```css
/* static/css/rtl.css */
[dir="rtl"] {
    /* Genel RTL stilleri */
    text-align: right;
}

[dir="rtl"] .navbar-nav {
    padding-right: 0;
}

[dir="rtl"] .dropdown-menu {
    text-align: right;
}

[dir="rtl"] .form-control {
    text-align: right;
}

/* RTL Ã¶zel bileÅŸen stilleri */
[dir="rtl"] .invoice-header {
    flex-direction: row-reverse;
}

[dir="rtl"] .payment-details {
    padding-right: 20px;
    padding-left: 0;
}
```

#### 3.2. JavaScript Entegrasyonu
```javascript
// static/js/rtl.js
class RTLManager {
    constructor() {
        this.rtlLanguages = ['ar', 'ku'];
    }
    
    isRTL(languageCode) {
        return this.rtlLanguages.includes(languageCode);
    }
    
    applyRTLSettings(languageCode) {
        const isRTL = this.isRTL(languageCode);
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
        document.documentElement.lang = languageCode;
        
        // RTL CSS sÄ±nÄ±fÄ±nÄ± ekle/kaldÄ±r
        document.body.classList.toggle('rtl', isRTL);
        
        // Font deÄŸiÅŸiklikleri
        if (isRTL) {
            this.loadRTLFonts();
        } else {
            this.loadLTRFonts();
        }
    }
    
    loadRTLFonts() {
        // RTL dilleri iÃ§in Ã¶zel fontlar yÃ¼kle
        const fontLink = document.createElement('link');
        fontLink.rel = 'stylesheet';
        fontLink.href = 'https://fonts.googleapis.com/css2?family=Amiri&display=swap';
        document.head.appendChild(fontLink);
    }
    
    loadLTRFonts() {
        // LTR dilleri iÃ§in Ã¶zel fontlar
    }
}

// Dil deÄŸiÅŸikliÄŸinde RTL ayarlarÄ±nÄ± uygula
function changeLanguage(languageCode) {
    const rtlManager = new RTLManager();
    rtlManager.applyRTLSettings(languageCode);
    
    // Dil deÄŸiÅŸikliÄŸi isteÄŸi gÃ¶nder
    fetch('/api/change-language/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ language: languageCode })
    }).then(() => {
        window.location.reload();
    });
}
```

### 4. Dil Tespiti
```python
# i18n/utils.py
from django.utils.translation import get_language
from django.conf import settings
import re

def detect_language_from_request(request):
    """
    TarayÄ±cÄ± dilini tespit et ve desteklenen dillere gÃ¶re eÅŸleÅŸtir
    """
    accept_language = request.META.get('HTTP_ACCEPT_LANGUAGE', '')
    supported_langs = [lang[0] for lang in settings.LANGUAGES]
    
    best_match = None
    highest_q = 0
    
    for lang_q in accept_language.split(','):
        parts = lang_q.split(';q=')
        lang = parts[0].strip().split('-')[0]  # Ã–rn: 'en-US' -> 'en'
        q = float(parts[1]) if len(parts) > 1 else 1.0
        
        if lang in supported_langs and q > highest_q:
            best_match = lang
            highest_q = q
    
    return best_match or settings.LANGUAGE_CODE

# i18n/middleware.py
class AutoLanguageMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        if not request.session.get('django_language'):
            lang = detect_language_from_request(request)
            request.session['django_language'] = lang
            translation.activate(lang)
        
        response = self.get_response(request)
        return response
```

## ğŸ”§ KullanÄ±m AdÄ±mlarÄ±

### 1. Yeni Dil Ekleme

#### 1.1. Dil DosyasÄ± OluÅŸturma
```bash
# Dil dizini oluÅŸtur
mkdir -p locale/tr/LC_MESSAGES
mkdir -p locale/en/LC_MESSAGES
mkdir -p locale/ku/LC_MESSAGES
mkdir -p locale/ar/LC_MESSAGES
mkdir -p locale/de/LC_MESSAGES
mkdir -p locale/fr/LC_MESSAGES

# Django Ã§eviri dosyalarÄ±nÄ± oluÅŸtur
python manage.py makemessages -l tr -l en -l ku -l ar -l de -l fr
```

#### 1.2. Ã‡eviri Ekleme
```python
# i18n/management/commands/update_translations.py
from django.core.management.base import BaseCommand
import json
import os
import polib

class Command(BaseCommand):
    help = 'JSON Ã§evirilerini Django .po dosyalarÄ±na aktarÄ±r'
    
    def add_arguments(self, parser):
        parser.add_argument('language', type=str, help='Dil kodu (tr, en, vb.)')
    
    def handle(self, *args, **options):
        language = options['language']
        json_path = os.path.join('locale', language, 'LC_MESSAGES', 'django.json')
        po_path = os.path.join('locale', language, 'LC_MESSAGES', 'django.po')
        
        # JSON dosyasÄ±nÄ± yÃ¼kle
        with open(json_path, 'r', encoding='utf-8') as f:
            translations = json.load(f)
        
        # PO dosyasÄ±nÄ± yÃ¼kle
        try:
            po = polib.pofile(po_path)
        except Exception:
            self.stdout.write(self.style.ERROR(f'{po_path} dosyasÄ± bulunamadÄ±.'))
            return
        
        # JSON Ã§evirilerini dÃ¼z Ã§eviri anahtarlarÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
        flat_translations = self.flatten_dict(translations)
        
        # Ã‡evirileri PO dosyasÄ±na ekle
        added_count = 0
        for key, value in flat_translations.items():
            entry = po.find(key)
            if entry:
                entry.msgstr = value
                added_count += 1
            else:
                new_entry = polib.POEntry(
                    msgid=key,
                    msgstr=value
                )
                po.append(new_entry)
                added_count += 1
        
        # PO dosyasÄ±nÄ± kaydet
        po.save()
        
        # MO dosyasÄ±nÄ± oluÅŸtur
        po.save_as_mofile(po_path.replace('.po', '.mo'))
        
        self.stdout.write(
            self.style.SUCCESS(f'{added_count} Ã§eviri {language} diline eklendi.')
        )
    
    def flatten_dict(self, d, parent_key='', sep='.'):
        items = []
        for k, v in d.items():
            new_key = f"{parent_key}{sep}{k}" if parent_key else k
            if isinstance(v, dict):
                items.extend(self.flatten_dict(v, new_key, sep=sep).items())
            else:
                items.append((new_key, v))
        return dict(items)
```

### 2. RTL DesteÄŸi Ekleme

#### 2.1. Template Entegrasyonu
```html
<!-- templates/base.html -->
{% load static %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <!-- Temel CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    
    <!-- RTL CSS, yalnÄ±zca RTL dilleri iÃ§in -->
    {% if LANGUAGE_BIDI %}
    <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
    {% endif %}
    
    <script src="{% static 'js/rtl.js' %}"></script>
</head>
<body class="{% if LANGUAGE_BIDI %}rtl{% endif %}">
    <!-- Sayfa iÃ§eriÄŸi -->
</body>
</html>
```

#### 2.2. Dil SeÃ§ici BileÅŸeni
```html
<!-- templates/components/language_switcher.html -->
{% load i18n %}

<div class="language-switcher">
    <div class="current-language">
        {% get_language_info for LANGUAGE_CODE as current_lang %}
        <span>{{ current_lang.name_local }}</span>
        <i class="fas fa-caret-down"></i>
    </div>
    
    <ul class="language-options">
        {% get_available_languages as LANGUAGES %}
        {% get_language_info_list for LANGUAGES as languages %}
        {% for language in languages %}
            <li {% if language.code == LANGUAGE_CODE %}class="active"{% endif %}>
                <a href="#" onclick="changeLanguage('{{ language.code }}'); return false;">
                    {{ language.name_local }}
                </a>
            </li>
        {% endfor %}
    </ul>
</div>
```

### 3. Ã‡evirileri Derleme ve CI/CD Entegrasyonu

SÃ¼rekli entegrasyon (CI) ve sÃ¼rekli daÄŸÄ±tÄ±m (CD) sÃ¼reÃ§lerinde dil dosyalarÄ±nÄ±n otomatik olarak derlenmesi iÃ§in gerekli adÄ±mlar:

```yaml
# .github/workflows/django-deploy.yml
name: Django Deployment

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Compile translations
        run: |
          python manage.py compilemessages --locale=tr --locale=en --locale=de --locale=fr --locale=ar --locale=ku
          
      # DiÄŸer derleme adÄ±mlarÄ±...
```

## ğŸ§ª Test Ã–rnekleri

### 1. Dil YÃ¼kleyici Testi
```python
# tests/test_i18n.py
from django.test import TestCase
from i18n.loader import LanguageLoader

class LanguageLoaderTest(TestCase):
    def setUp(self):
        self.loader = LanguageLoader()
    
    def test_load_language(self):
        translations = self.loader.load_language('tr')
        self.assertIn('common', translations)
        self.assertIn('save', translations['common'])
    
    def test_get_translation(self):
        translation = self.loader.get_translation('common.save', 'tr')
        self.assertEqual(translation, 'Kaydet')
        
    def test_fallback_to_default_language(self):
        # Olmayan bir dil iÃ§in varsayÄ±lan dile dÃ¼ÅŸmeli
        translation = self.loader.get_translation('common.save', 'xx')
        self.assertEqual(translation, 'Kaydet')  # VarsayÄ±lan dil tr olduÄŸu iÃ§in
```

### 2. RTL YÃ¶netici Testi
```javascript
// tests/rtl.test.js
describe('RTLManager', () => {
    let rtlManager;
    
    beforeEach(() => {
        rtlManager = new RTLManager();
        document.documentElement.dir = 'ltr';
        document.body.classList.remove('rtl');
    });
    
    test('should detect RTL languages', () => {
        expect(rtlManager.isRTL('ar')).toBe(true);
        expect(rtlManager.isRTL('ku')).toBe(true);
        expect(rtlManager.isRTL('en')).toBe(false);
        expect(rtlManager.isRTL('tr')).toBe(false);
    });
    
    test('should apply RTL settings', () => {
        rtlManager.applyRTLSettings('ar');
        expect(document.documentElement.dir).toBe('rtl');
        expect(document.body.classList.contains('rtl')).toBe(true);
        
        rtlManager.applyRTLSettings('en');
        expect(document.documentElement.dir).toBe('ltr');
        expect(document.body.classList.contains('rtl')).toBe(false);
    });
    
    test('should load RTL fonts for RTL languages', () => {
        const spy = jest.spyOn(rtlManager, 'loadRTLFonts');
        rtlManager.applyRTLSettings('ar');
        expect(spy).toHaveBeenCalled();
    });
});
```

### 3. Dil DeÄŸiÅŸtirme Testi
```python
# tests/test_views.py
from django.test import TestCase, Client
from django.urls import reverse

class LanguageSwitchTest(TestCase):
    def setUp(self):
        self.client = Client()
    
    def test_language_switch(self):
        # VarsayÄ±lan dil kontrolÃ¼
        response = self.client.get(reverse('home'))
        self.assertEqual(response.context['LANGUAGE_CODE'], 'tr')
        
        # Dil deÄŸiÅŸtirme
        response = self.client.post(
            reverse('set_language'),
            {'language': 'en'},
            follow=True
        )
        self.assertEqual(response.context['LANGUAGE_CODE'], 'en')
        
        # Ã‡erezde dil ayarÄ±nÄ±n kaydedildiÄŸini kontrol et
        self.assertEqual(self.client.session['django_language'], 'en')
```

## ğŸ“ SÄ±k KarÅŸÄ±laÅŸÄ±lan Sorunlar ve Ã‡Ã¶zÃ¼mleri

### 1. Ã‡eviri Eksiklikleri
**Sorun**: BazÄ± metinler Ã§evrilmemiÅŸ
**Ã‡Ã¶zÃ¼m**:
- Eksik Ã§evirileri kontrol edin
- VarsayÄ±lan dil dosyasÄ±nÄ± gÃ¼ncelleyin
- Ã‡eviri anahtarlarÄ±nÄ± doÄŸrulayÄ±n
- `./manage.py makemessages` komutunu Ã§alÄ±ÅŸtÄ±rarak eksik metinleri bulun

### 2. RTL GÃ¶rÃ¼nÃ¼m SorunlarÄ±
**Sorun**: RTL dillerde gÃ¶rÃ¼nÃ¼m bozuk
**Ã‡Ã¶zÃ¼m**:
- CSS Ã¶zelliklerini kontrol edin
- Flexbox yÃ¶nlendirmelerini dÃ¼zeltin
- Margin/padding deÄŸerlerini ayarlayÄ±n
- `[dir="rtl"]` seÃ§icisini kullanarak Ã¶zel RTL stillerini tanÄ±mlayÄ±n

### 3. Dil DeÄŸiÅŸtirme HatalarÄ±
**Sorun**: Dil deÄŸiÅŸikliÄŸi Ã§alÄ±ÅŸmÄ±yor
**Ã‡Ã¶zÃ¼m**:
- Session ayarlarÄ±nÄ± kontrol edin
- Middleware sÄ±rasÄ±nÄ± doÄŸrulayÄ±n (`LocaleMiddleware` doÄŸru sÄ±rada olmalÄ±)
- TarayÄ±cÄ± Ã¶nbelleÄŸini temizleyin
- Ã‡erez ayarlarÄ±nÄ± kontrol edin

### 4. Derleme SorunlarÄ±
**Sorun**: `.mo` dosyalarÄ± oluÅŸturulmuyor
**Ã‡Ã¶zÃ¼m**:
- `gettext` paketinin yÃ¼klÃ¼ olduÄŸunu kontrol edin
- `compilemessages` komutunu Ã§alÄ±ÅŸtÄ±rÄ±rken hata Ã§Ä±ktÄ±larÄ±nÄ± inceleyin
- Dosya izinlerini kontrol edin
- `.po` dosyalarÄ±ndaki sÃ¶zdizimi hatalarÄ±nÄ± dÃ¼zeltin

## ğŸ“‚ Dosya YapÄ±sÄ± ve Referanslar

```
finasis/
â”œâ”€â”€ locale/
â”‚   â”œâ”€â”€ tr/
â”‚   â”‚   â””â”€â”€ LC_MESSAGES/
â”‚   â”‚       â”œâ”€â”€ django.po
â”‚   â”‚       â”œâ”€â”€ django.mo
â”‚   â”‚       â””â”€â”€ django.json
â”‚   â”œâ”€â”€ en/
â”‚   â”‚   â””â”€â”€ LC_MESSAGES/
â”‚   â”‚       â”œâ”€â”€ django.po
â”‚   â”‚       â”œâ”€â”€ django.mo
â”‚   â”‚       â””â”€â”€ django.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ main.css
â”‚   â”‚   â””â”€â”€ rtl.css
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ rtl.js
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ components/
â”‚       â””â”€â”€ language_switcher.html
â””â”€â”€ i18n/
    â”œâ”€â”€ loader.py
    â”œâ”€â”€ middleware.py
    â”œâ”€â”€ utils.py
    â””â”€â”€ management/
        â””â”€â”€ commands/
            â”œâ”€â”€ compile_messages.py
            â””â”€â”€ update_translations.py
```

## ğŸ” Ek Kaynaklar

- [Django i18n DokÃ¼mantasyonu](https://docs.djangoproject.com/en/stable/topics/i18n/)
- [RTL Stil Rehberi](https://rtlstyling.com/)
- [Unicode CLDR](http://cldr.unicode.org/)
- [Bidi Algorithm](https://www.w3.org/International/articles/inline-bidi-markup/) 