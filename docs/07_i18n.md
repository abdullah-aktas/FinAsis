# 7. Dil ve Yerelleştirme (i18n)

## 📌 Amaç
Bu dokümantasyon, FinAsis projesinin çoklu dil desteği ve yerelleştirme özelliklerini detaylandırmaktadır.

## ⚙️ Teknik Yapı

### 1. Dil Dosyaları

#### 1.1. JSON Tabanlı Dil Dosyaları
```json
// locale/tr/LC_MESSAGES/django.json
{
    "common": {
        "save": "Kaydet",
        "cancel": "İptal",
        "delete": "Sil",
        "edit": "Düzenle",
        "search": "Ara",
        "filter": "Filtrele"
    },
    "auth": {
        "login": "Giriş Yap",
        "logout": "Çıkış Yap",
        "register": "Kayıt Ol",
        "password": "Şifre",
        "email": "E-posta"
    },
    "finance": {
        "invoice": "Fatura",
        "payment": "Ödeme",
        "customer": "Müşteri",
        "amount": "Tutar",
        "date": "Tarih",
        "status": "Durum"
    }
}
```

#### 1.2. Dil Yükleyici
```python
# i18n/loader.py
import json
import os
from django.conf import settings

class LanguageLoader:
    def __init__(self):
        self.translations = {}
        self.default_language = settings.LANGUAGE_CODE
    
    def load_language(self, language_code):
        if language_code not in self.translations:
            file_path = os.path.join(
                settings.BASE_DIR,
                'locale',
                language_code,
                'LC_MESSAGES',
                'django.json'
            )
            
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    self.translations[language_code] = json.load(f)
            except FileNotFoundError:
                self.translations[language_code] = {}
        
        return self.translations[language_code]
    
    def get_translation(self, key, language_code=None):
        language_code = language_code or self.default_language
        translations = self.load_language(language_code)
        
        keys = key.split('.')
        value = translations
        
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                return key
        
        return value
```

### 2. Çeviri Sistemi

#### 2.1. Django Entegrasyonu
```python
# settings.py
MIDDLEWARE = [
    'django.middleware.locale.LocaleMiddleware',
    # ...
]

LANGUAGES = [
    ('tr', 'Türkçe'),
    ('en', 'English'),
    ('ku', 'Kurdî'),
    ('ar', 'العربية'),
    ('de', 'Deutsch')
]

LOCALE_PATHS = [
    os.path.join(BASE_DIR, 'locale'),
]

# i18n/middleware.py
from django.utils import translation
from django.conf import settings

class LanguageMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
    
    def __call__(self, request):
        # Kullanıcı tercihini kontrol et
        user_language = request.session.get('django_language')
        if user_language:
            translation.activate(user_language)
        
        response = self.get_response(request)
        return response
```

#### 2.2. Template Kullanımı
```html
<!-- templates/base.html -->
{% load i18n %}

<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <title>{% trans "FinAsis" %}</title>
</head>
<body>
    <nav>
        <select onchange="changeLanguage(this.value)">
            {% get_available_languages as LANGUAGES %}
            {% get_language_info_list for LANGUAGES as languages %}
            {% for language in languages %}
                <option value="{{ language.code }}"
                        {% if language.code == LANGUAGE_CODE %}selected{% endif %}>
                    {{ language.name_local }}
                </option>
            {% endfor %}
        </select>
    </nav>
    
    <main>
        {% block content %}{% endblock %}
    </main>
</body>
</html>
```

### 3. RTL Desteği

#### 3.1. CSS Yapılandırması
```css
/* static/css/rtl.css */
[dir="rtl"] {
    /* Genel RTL stilleri */
    text-align: right;
}

[dir="rtl"] .navbar-nav {
    padding-right: 0;
}

[dir="rtl"] .dropdown-menu {
    text-align: right;
}

[dir="rtl"] .form-control {
    text-align: right;
}

/* RTL özel bileşen stilleri */
[dir="rtl"] .invoice-header {
    flex-direction: row-reverse;
}

[dir="rtl"] .payment-details {
    padding-right: 20px;
    padding-left: 0;
}
```

#### 3.2. JavaScript Entegrasyonu
```javascript
// static/js/rtl.js
class RTLManager {
    constructor() {
        this.rtlLanguages = ['ar', 'ku'];
    }
    
    isRTL(languageCode) {
        return this.rtlLanguages.includes(languageCode);
    }
    
    applyRTLSettings(languageCode) {
        const isRTL = this.isRTL(languageCode);
        document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
        document.documentElement.lang = languageCode;
        
        // RTL CSS sınıfını ekle/kaldır
        document.body.classList.toggle('rtl', isRTL);
    }
}

// Dil değişikliğinde RTL ayarlarını uygula
function changeLanguage(languageCode) {
    const rtlManager = new RTLManager();
    rtlManager.applyRTLSettings(languageCode);
    
    // Dil değişikliği isteği gönder
    fetch('/api/change-language/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ language: languageCode })
    }).then(() => {
        window.location.reload();
    });
}
```

## 🔧 Kullanım Adımları

### 1. Yeni Dil Ekleme

#### 1.1. Dil Dosyası Oluşturma
```bash
# Dil dizini oluştur
mkdir -p locale/tr/LC_MESSAGES
mkdir -p locale/en/LC_MESSAGES
mkdir -p locale/ku/LC_MESSAGES
mkdir -p locale/ar/LC_MESSAGES
mkdir -p locale/de/LC_MESSAGES

# Dil dosyalarını oluştur
touch locale/*/LC_MESSAGES/django.json
```

#### 1.2. Çeviri Ekleme
```python
# i18n/management/commands/compile_messages.py
from django.core.management.base import BaseCommand
import json
import os

class Command(BaseCommand):
    help = 'Dil dosyalarını derle'
    
    def handle(self, *args, **options):
        locale_dir = 'locale'
        
        for lang_code in os.listdir(locale_dir):
            lang_path = os.path.join(locale_dir, lang_code)
            if os.path.isdir(lang_path):
                messages_path = os.path.join(
                    lang_path,
                    'LC_MESSAGES',
                    'django.json'
                )
                
                if os.path.exists(messages_path):
                    with open(messages_path, 'r', encoding='utf-8') as f:
                        messages = json.load(f)
                    
                    # Çevirileri derle
                    compiled_path = messages_path.replace('.json', '.mo')
                    self.compile_messages(messages, compiled_path)
    
    def compile_messages(self, messages, output_path):
        # Mesajları derle ve kaydet
        pass
```

### 2. RTL Desteği Ekleme

#### 2.1. Template Entegrasyonu
```html
<!-- templates/base.html -->
{% load static %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}">
<head>
    <link rel="stylesheet" href="{% static 'css/rtl.css' %}">
    <script src="{% static 'js/rtl.js' %}"></script>
</head>
<body class="{% if LANGUAGE_BIDI %}rtl{% endif %}">
    <!-- Sayfa içeriği -->
</body>
</html>
```

## 🧪 Test Örnekleri

### 1. Dil Yükleyici Testi
```python
# tests/test_i18n.py
from django.test import TestCase
from i18n.loader import LanguageLoader

class LanguageLoaderTest(TestCase):
    def setUp(self):
        self.loader = LanguageLoader()
    
    def test_load_language(self):
        translations = self.loader.load_language('tr')
        self.assertIn('common', translations)
        self.assertIn('save', translations['common'])
    
    def test_get_translation(self):
        translation = self.loader.get_translation('common.save', 'tr')
        self.assertEqual(translation, 'Kaydet')
```

### 2. RTL Yönetici Testi
```javascript
// tests/rtl.test.js
describe('RTLManager', () => {
    let rtlManager;
    
    beforeEach(() => {
        rtlManager = new RTLManager();
    });
    
    test('should detect RTL languages', () => {
        expect(rtlManager.isRTL('ar')).toBe(true);
        expect(rtlManager.isRTL('en')).toBe(false);
    });
    
    test('should apply RTL settings', () => {
        rtlManager.applyRTLSettings('ar');
        expect(document.documentElement.dir).toBe('rtl');
        expect(document.body.classList.contains('rtl')).toBe(true);
    });
});
```

## 📝 Sık Karşılaşılan Sorunlar ve Çözümleri

### 1. Çeviri Eksiklikleri
**Sorun**: Bazı metinler çevrilmemiş
**Çözüm**:
- Eksik çevirileri kontrol edin
- Varsayılan dil dosyasını güncelleyin
- Çeviri anahtarlarını doğrulayın

### 2. RTL Görünüm Sorunları
**Sorun**: RTL dillerde görünüm bozuk
**Çözüm**:
- CSS özelliklerini kontrol edin
- Flexbox yönlendirmelerini düzeltin
- Margin/padding değerlerini ayarlayın

### 3. Dil Değiştirme Hataları
**Sorun**: Dil değişikliği çalışmıyor
**Çözüm**:
- Session ayarlarını kontrol edin
- Middleware sırasını doğrulayın
- Tarayıcı önbelleğini temizleyin

## 📂 Dosya Yapısı ve Referanslar

```
finasis/
├── locale/
│   ├── tr/
│   │   └── LC_MESSAGES/
│   │       └── django.json
│   ├── en/
│   │   └── LC_MESSAGES/
│   │       └── django.json
│   └── ...
├── static/
│   ├── css/
│   │   └── rtl.css
│   └── js/
│       └── rtl.js
└── i18n/
    ├── loader.py
    ├── middleware.py
    └── management/
        └── commands/
            └── compile_messages.py
```

## 🔍 Ek Kaynaklar

- [Django i18n Dokümantasyonu](https://docs.djangoproject.com/en/stable/topics/i18n/)
- [RTL Stil Rehberi](https://rtlstyling.com/)
- [Unicode CLDR](http://cldr.unicode.org/)
- [Bidi Algorithm](https://www.w3.org/International/articles/inline-bidi-markup/) 